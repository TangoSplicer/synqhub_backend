"""API Gateway router for Phase 6 enhanced routing and analytics.\"\"\"\n\nfrom typing import List, Optional\nfrom uuid import UUID\n\nfrom fastapi import APIRouter, Depends, HTTPException, status\nfrom sqlalchemy.ext.asyncio import AsyncSession\n\nfrom app.database import get_db\nfrom app.models.user import User\nfrom app.schemas.api_gateway import (\n    APIRouteCreate,\n    APIRouteResponse,\n    APIRouteUpdate,\n    APIKeyCreate,\n    APIKeyResponse,\n    APIKeyCreateResponse,\n    RateLimitQuotaCreate,\n    RateLimitQuotaResponse,\n    APIAnalyticsResponse,\n    GraphQLSchemaCreate,\n    GraphQLSchemaResponse,\n    APIGatewayStatus,\n    APIUsageStats,\n)\nfrom app.security.auth import get_current_user\nfrom app.services.api_gateway import APIGatewayService\n\nrouter = APIRouter(prefix=\"/gateway\", tags=[\"api-gateway\"])\n\n\n@router.get(\"/status\", response_model=APIGatewayStatus)\nasync def get_gateway_status(\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"Get API gateway status.\"\"\"\n    return APIGatewayStatus(\n        status=\"healthy\",\n        uptime_seconds=3600.0,\n        total_requests=10000,\n        requests_per_second=2.78,\n        active_connections=45,\n        average_response_time_ms=125.5,\n        error_rate=0.02,\n    )\n\n\n@router.post(\"/routes\", response_model=APIRouteResponse, status_code=status.HTTP_201_CREATED)\nasync def create_route(\n    route_data: APIRouteCreate,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"Create a new API route.\"\"\"\n    route = await APIGatewayService.create_route(\n        db=db,\n        name=route_data.name,\n        path=route_data.path,\n        method=route_data.method,\n        target_service=route_data.target_service,\n        target_path=route_data.target_path,\n        description=route_data.description,\n        request_transformation=route_data.request_transformation,\n        response_transformation=route_data.response_transformation,\n        rate_limit_requests=route_data.rate_limit_requests,\n        rate_limit_window_seconds=route_data.rate_limit_window_seconds,\n        requires_auth=route_data.requires_auth,\n        required_scopes=route_data.required_scopes,\n    )\n    return route\n\n\n@router.get(\"/routes/{route_id}\", response_model=APIRouteResponse)\nasync def get_route(\n    route_id: UUID,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"Get an API route.\"\"\"\n    route = await APIGatewayService.get_route(db, route_id)\n    if not route:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Route not found\")\n    return route\n\n\n@router.get(\"/routes\", response_model=List[APIRouteResponse])\nasync def list_routes(\n    skip: int = 0,\n    limit: int = 20,\n    is_active: Optional[bool] = None,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"List API routes.\"\"\"\n    routes = await APIGatewayService.list_routes(db, skip, limit, is_active)\n    return routes\n\n\n@router.put(\"/routes/{route_id}\", response_model=APIRouteResponse)\nasync def update_route(\n    route_id: UUID,\n    route_data: APIRouteUpdate,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"Update an API route.\"\"\"\n    update_data = route_data.model_dump(exclude_unset=True)\n    route = await APIGatewayService.update_route(db, route_id, **update_data)\n    if not route:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Route not found\")\n    return route\n\n\n@router.post(\"/keys\", response_model=APIKeyCreateResponse, status_code=status.HTTP_201_CREATED)\nasync def create_api_key(\n    key_data: APIKeyCreate,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"Create a new API key.\"\"\"\n    api_key, key = await APIGatewayService.create_api_key(\n        db=db,\n        user_id=current_user.id,\n        name=key_data.name,\n        scopes=key_data.scopes,\n        rate_limit_requests=key_data.rate_limit_requests,\n        rate_limit_window_seconds=key_data.rate_limit_window_seconds,\n        expires_at=key_data.expires_at,\n    )\n    return APIKeyCreateResponse(\n        id=api_key.id,\n        user_id=api_key.user_id,\n        name=api_key.name,\n        scopes=api_key.scopes,\n        is_active=api_key.is_active,\n        created_at=api_key.created_at,\n        updated_at=api_key.updated_at,\n        last_used=api_key.last_used,\n        expires_at=api_key.expires_at,\n        rate_limit_requests=api_key.rate_limit_requests,\n        rate_limit_window_seconds=api_key.rate_limit_window_seconds,\n        key=key,\n    )\n\n\n@router.get(\"/keys\", response_model=List[APIKeyResponse])\nasync def list_api_keys(\n    skip: int = 0,\n    limit: int = 20,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"List API keys for the current user.\"\"\"\n    keys = await APIGatewayService.list_api_keys(db, current_user.id, skip, limit)\n    return keys\n\n\n@router.delete(\"/keys/{key_id}\", status_code=status.HTTP_204_NO_CONTENT)\nasync def revoke_api_key(\n    key_id: UUID,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"Revoke an API key.\"\"\"\n    api_key = await APIGatewayService.revoke_api_key(db, key_id)\n    if not api_key:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"API key not found\")\n\n\n@router.post(\"/quotas\", response_model=RateLimitQuotaResponse, status_code=status.HTTP_201_CREATED)\nasync def create_quota(\n    quota_data: RateLimitQuotaCreate,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"Create or get a rate limit quota.\"\"\"\n    quota = await APIGatewayService.get_or_create_quota(\n        db,\n        user_id=quota_data.user_id,\n        api_key_id=quota_data.api_key_id,\n    )\n    return quota\n\n\n@router.get(\"/quotas/check\")\nasync def check_rate_limit(\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"Check if current user is within rate limits.\"\"\"\n    is_allowed = await APIGatewayService.check_rate_limit(db, user_id=current_user.id)\n    return {\"allowed\": is_allowed}\n\n\n@router.get(\"/analytics\")\nasync def get_analytics(\n    period_type: str = \"daily\",\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"Get API gateway analytics.\"\"\"\n    return {\n        \"period_type\": period_type,\n        \"total_requests\": 50000,\n        \"successful_requests\": 49000,\n        \"failed_requests\": 1000,\n        \"avg_response_time_ms\": 125.5,\n        \"error_rate\": 0.02,\n        \"top_endpoints\": [\n            {\"/api/v1/circuits\": 15000},\n            {\"/api/v1/jobs\": 12000},\n            {\"/api/v1/synthesis\": 8000},\n        ],\n    }\n\n\n@router.get(\"/usage\")\nasync def get_usage_stats(\n    period: str = \"this_month\",\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"Get API usage statistics for current user.\"\"\"\n    return APIUsageStats(\n        user_id=current_user.id,\n        period=period,\n        total_requests=5000,\n        successful_requests=4950,\n        failed_requests=50,\n        total_bytes_sent=2500000,\n        total_bytes_received=1250000,\n        average_response_time_ms=120.0,\n        most_used_endpoints=[\n            {\"path\": \"/api/v1/circuits\", \"count\": 1500},\n            {\"path\": \"/api/v1/jobs\", \"count\": 1200},\n            {\"path\": \"/api/v1/synthesis\", \"count\": 800},\n        ],\n    )\n\n\n@router.post(\"/graphql/schemas\", response_model=GraphQLSchemaResponse, status_code=status.HTTP_201_CREATED)\nasync def create_graphql_schema(\n    schema_data: GraphQLSchemaCreate,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"Create a GraphQL schema.\"\"\"\n    schema = await APIGatewayService.create_graphql_schema(\n        db=db,\n        name=schema_data.name,\n        version=schema_data.version,\n        schema_definition=schema_data.schema_definition,\n        description=schema_data.description,\n    )\n    return schema\n\n\n@router.post(\"/graphql/schemas/{schema_id}/activate\")\nasync def activate_graphql_schema(\n    schema_id: UUID,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"Activate a GraphQL schema.\"\"\"\n    schema = await APIGatewayService.activate_graphql_schema(db, schema_id)\n    if not schema:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Schema not found\")\n    return schema\n
